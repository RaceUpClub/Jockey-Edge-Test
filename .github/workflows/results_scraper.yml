name: Wettstar Results Scraper

on:
  workflow_dispatch:
    inputs:
      from_date:
        description: 'Von Datum (YYYY-MM-DD)'
        required: true
        default: '2025-01-01'
      to_date:
        description: 'Bis Datum (YYYY-MM-DD)'
        required: true
        default: '2025-12-31'

jobs:
  scrape-results:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          pip install playwright beautifulsoup4
          playwright install chromium
          playwright install-deps chromium

      - name: Run Scraper
        run: |
          python wettstar_results_scraper.py \
            --from-date ${{ github.event.inputs.from_date }} \
            --to-date   ${{ github.event.inputs.to_date }} \
            --output    ./race_results/

      - name: Summary
        if: always()   # LÃ¤uft auch wenn Scraper nichts findet
        run: |
          echo "=== Output-Dateien ==="
          ls -lh ./race_results/ 2>/dev/null || echo "Kein Output-Verzeichnis"
          echo ""
          echo "=== CSVs ==="
          if ls ./race_results/*.csv 2>/dev/null; then
            wc -l ./race_results/*.csv
            echo ""
            echo "=== Erste 3 Zeilen ==="
            head -3 ./race_results/race_results_*.csv
          else
            echo "Keine CSV erzeugt"
          fi
          echo ""
          echo "=== Checkpoint (scraped_ids.json) ==="
          if [ -f ./race_results/scraped_ids.json ]; then
            python3 -c "import json; ids=json.load(open('./race_results/scraped_ids.json')); print(f'{len(ids)} IDs im Checkpoint')"
          else
            echo "Kein Checkpoint"
          fi

      - name: Upload Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: race-results-${{ github.event.inputs.from_date }}-${{ github.event.inputs.to_date }}
          path: ./race_results/
          retention-days: 90
